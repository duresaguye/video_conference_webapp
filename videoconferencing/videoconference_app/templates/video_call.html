<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            width: 100%;
            max-width: 800px;
        }

        video {
            width: 100%;
            height: auto;
            border: 1px solid black;
        }

        #chat-container {
            margin-top: 20px;
            width: 100%;
            max-width: 800px;
        }

        #chat-log {
            width: 100%;
            height: 200px;
            overflow-y: auto;
        }

        #chat-message-input {
            width: 80%;
        }
    </style>
    <script>
        const videoGrid = document.getElementById('video-grid');
        const myVideo = document.createElement('video');
        myVideo.muted = true;

        let myStream;
        const peers = {};

        // Initialize WebRTC
        async function initWebRTC() {
            myStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });

            addVideoStream(myVideo, myStream);

            // Here you will need to implement the signaling server to communicate with other peers
            // For example:
            // const socket = new WebSocket('ws://your-websocket-server');
            // socket.onmessage = handleNewSignal;

            // On connection with another user, use peer connection to establish a call
        }

        function addVideoStream(video, stream) {
            video.srcObject = stream;
            video.addEventListener('loadedmetadata', () => {
                video.play();
            });
            videoGrid.append(video);
        }

        initWebRTC();

        // Handle chat functionality
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/general/'); // Replace 'general' with your room name

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            const chatLog = document.querySelector('#chat-log');
            chatLog.value += (data.username + ": " + data.message + '\n');
            chatLog.scrollTop = chatLog.scrollHeight; // Scroll to the bottom
        };

        document.querySelector('#chat-message-input').onkeyup = function (e) {
            if (e.keyCode === 13) {  // Enter key
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function (e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message,
                'username': "{{ username }}"
            }));
            messageInputDom.value = '';
        };
    </script>
</head>

<body>
    <h2>Video Call</h2>
    <div id="video-grid"></div> <!-- This is where the video will appear -->

    <div id="chat-container">
        <h3>Chat Room</h3>
        <textarea id="chat-log" readonly></textarea><br>
        <input id="chat-message-input" type="text" placeholder="Type your message here...">
        <button id="chat-message-submit">Send</button>
    </div>
</body>

</html>